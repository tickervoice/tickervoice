<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Investing.com Price TTS Demo</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:24px;background:#f7fafc;color:#0f172a}
.card{background:white;padding:18px;border-radius:12px;box-shadow:0 6px 18px rgba(15,23,42,0.08);max-width:1000px}
input, button, select {padding:8px 10px;font-size:15px;border-radius:8px;border:1px solid #e6eef6;color:#000;}
button{background:#2563eb;color:white;border:0;font-weight:600;cursor:pointer;}
.row{display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
.kv{background:#f1f5f9;padding:10px 14px;border-radius:8px;min-width:140px;text-align:center}
.muted{color:#64748b;font-size:14px}
.ticker-row{flex-direction:column;align-items:flex-start;border:1px solid #e5e7eb;padding:8px;border-radius:10px;margin-bottom:10px;background:#fafafa}
.ticker-line1{display:flex;align-items:center;gap:6px;width:100%}
.ticker-line2{display:flex;align-items:center;gap:6px;width:100%;margin-top:4px}
.ticker-row input{flex:1}
.remove-btn{flex:0 0 30px}
.price-box{margin-left:auto;display:flex;flex-direction:column;align-items:center}
.price-value{font-weight:600;font-size:16px}
.pct-value{font-size:14px}
.warning-input{flex:2}
.daypct-input{flex:1;max-width:100px}
</style>
</head>
<body>
<div class="card">
<h2>Investing.com Price TTS Demo</h2>

<div class="row">
  <label>Refresh:
    <select id="refresh">
      <option value="5000" selected>5s</option>
      <option value="10000">10s</option>
      <option value="15000">15s</option>
      <option value="20000">20s</option>
      <option value="30000">30s</option>
      <option value="60000">60s</option>
    </select>
  </label>
  <button id="addTicker">+ Add Ticker</button>
  <button id="clearAll">Clear All</button>
</div>

<div id="status" class="muted">Ready.</div>
<div id="tickerContainer"></div>
</div>

<script>
const $ = id => document.getElementById(id);
let refreshTimer = null;
let triggerCount = {};
let lastPrice = {};
let lastPct = {};

// TTS voices
let maleVoice = null;
let femaleVoice = null;

function loadVoices() {
  const voices = speechSynthesis.getVoices();
  maleVoice = voices.find(v => /male|David|Google UK English Male/i.test(v.name)) || voices[0];
  femaleVoice = voices.find(v => /female|Zira|Google US English/i.test(v.name)) || voices[1] || voices[0];
}
if (speechSynthesis.onvoiceschanged !== undefined) {
  speechSynthesis.onvoiceschanged = loadVoices;
}
loadVoices();

function speakNormal(text) {
  if (window.speechSynthesis) {
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'en-US';
    u.rate = 1.6;
    u.pitch = 1.0;
    if (maleVoice) u.voice = maleVoice;
    window.speechSynthesis.speak(u);
  }
}
function speakAlert(text) {
  if (window.speechSynthesis) {
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'en-US';
    u.rate = 1.4;
    u.pitch = 1.2;
    if (femaleVoice) u.voice = femaleVoice;
    window.speechSynthesis.speak(u);
  }
}

// Cookies
function setCookie(name,value,days=365){
  const d=new Date(); d.setTime(d.getTime()+days*24*60*60*1000);
  document.cookie=`${name}=${encodeURIComponent(value)};expires=${d.toUTCString()};path=/`;
}
function deleteCookie(name){
  document.cookie = name + '=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/';
}
function clearAllCookies(){
  document.cookie.split(';').forEach(c=>{
    const name=c.split('=')[0].trim();
    if(name.startsWith('row')) deleteCookie(name);
  });
  triggerCount={}; lastPrice={}; lastPct={};
  $('tickerContainer').innerHTML='';
}

// Add row
let tickerIndex=0;
function addTickerRow(ticker='',url='',stoploss='',stopbuy='',warning='',daypct='',ttsActive=false){
  tickerIndex++;
  const rowId='row'+tickerIndex;
  const container=$('tickerContainer');
  const row=document.createElement('div');
  row.className='ticker-row'; row.id=rowId;

  row.innerHTML=`
  <div class="ticker-line1">
    <input class="ticker-input" placeholder="Ticker" value="${ticker}">
    <input class="url-input" type="hidden" value="${url}">
    <input class="stoploss-input" placeholder="StopLoss" value="${stoploss}">
    <input class="stopbuy-input" placeholder="StopBuy" value="${stopbuy}">
    <button class="remove-btn">-</button>
    <div class="kv price-box">
      <div class="price-value">0.00</div>
      <div class="pct-value muted">0.00%</div>
    </div>
  </div>
  <div class="ticker-line2">
    <input class="warning-input" placeholder="Warning Prices by Comma" value="${warning}">
    <input class="daypct-input" placeholder="Day %" value="${daypct}">%
    <label><input type="checkbox" class="tts-checkbox" ${ttsActive?'checked':''}> Regular TTS</label>
  </div>
  `;
  container.appendChild(row);

  const tickerInput=row.querySelector('.ticker-input');
  const urlInput=row.querySelector('.url-input');
  const stoplossInput=row.querySelector('.stoploss-input');
  const stopbuyInput=row.querySelector('.stopbuy-input');
  const warningInput=row.querySelector('.warning-input');
  const daypctInput=row.querySelector('.daypct-input');
  const ttsBox=row.querySelector('.tts-checkbox');

  row.querySelector('.remove-btn').addEventListener('click',()=>{
    deleteCookie(row.id); delete triggerCount[row.id]; delete lastPrice[row.id]; delete lastPct[row.id]; row.remove();
  });

  // Input validation
  warningInput.addEventListener('input',()=>{
    let val=warningInput.value.replace(/[^0-9.,]/g,'');
    val=val.replace(/,+/g,',').replace(/^,|,$/g,'');
    warningInput.value=val;
  });
  daypctInput.addEventListener('input',()=>{
    let val=daypctInput.value.replace(/[^0-9.\-]/g,'');
    daypctInput.value=val;
  });

  function saveRowCookie(){
    const obj={
      ticker:tickerInput.value.trim(),
      url:urlInput.value.trim(),
      stoploss:stoplossInput.value.trim(),
      stopbuy:stopbuyInput.value.trim(),
      warning:warningInput.value.trim(),
      daypct:daypctInput.value.trim(),
      ttsActive:ttsBox.checked
    };
    if(obj.ticker) setCookie(row.id,JSON.stringify(obj));
  }
  [tickerInput,urlInput,stoplossInput,stopbuyInput,warningInput,daypctInput,ttsBox].forEach(inp=>{
    inp.addEventListener('input',saveRowCookie); inp.addEventListener('change',saveRowCookie);
  });

  tickerInput.addEventListener('focusout',()=>resolveInvestingUrl(tickerInput,urlInput,row));
}

// Resolve URL
async function resolveInvestingUrl(tickerInput,urlInput,row){
  const query=tickerInput.value.trim(); if(!query) return;
  try{
    const baseUrl='https://www.investing.com';
    const searchUrl=`${baseUrl}/search/?q=${encodeURIComponent(query)}`;
    const proxy='https://corsproxy.io/?'+encodeURIComponent(searchUrl);
    const resp=await fetch(proxy); const html=await resp.text();
    const m=html.match(/<a[^>]+js-inner-all-results-quote-item[^>]+href="([^"]+)"/);
    if(!m) return;
    urlInput.value=baseUrl+m[1];
  }catch(err){console.error('resolve failed',err);}
}

// Fetch
async function fetchTicker(row){
  const url=row.querySelector('.url-input').value.trim();
  if(!url) return;
  try{
    const proxy='https://corsproxy.io/?'+encodeURIComponent(url);
    const resp=await fetch(proxy); const html=await resp.text();

    // Price
    const match=html.match(/data-test="instrument-price-last">([\d.,]+)/);
    const price=match?parseFloat(match[1].replace(/,/g,'')):0;
    row.querySelector('.price-value').textContent=price.toFixed(2);

    // % change
    let pct=null;
    const pctMatch = html.match(/data-test="instrument-price-change-percent">\(<!-- -->\s*([\-0-9.]+)\s*<!-- -->%\)/i);
    if(pctMatch){
		  pct = parseFloat(pctMatch[1]);
		  const pctDiv = row.querySelector('.pct-value');
		  pctDiv.textContent = (pct>=0?`+${pct.toFixed(2)}%`:`${pct.toFixed(2)}%`);
		  pctDiv.style.color = pct>0 ? "green" : (pct<0 ? "red" : "#64748b");
		}

    const ticker=row.querySelector('.ticker-input').value;
    const ttsActive=row.querySelector('.tts-checkbox').checked;

    // Regular TTS on price change
    if(lastPrice[row.id]!==price && price>0){
      if(ttsActive) speakNormal(`${ticker} price ${price.toFixed(2)}`);
      lastPrice[row.id]=price;
    }

    if(!triggerCount[row.id]) triggerCount[row.id]={stoploss:0,stopbuy:0,daypct:0};

    // Stoploss/buy
    const sl=parseFloat(row.querySelector('.stoploss-input').value);
    const sb=parseFloat(row.querySelector('.stopbuy-input').value);
    if(!isNaN(sl)&&price<=sl){
      triggerCount[row.id].stoploss++;
      speakAlert(`${ticker} stopped out at $${price.toFixed(2)}`);
      if(triggerCount[row.id].stoploss>=3){row.querySelector('.stoploss-input').value=''; triggerCount[row.id].stoploss=0;}
    } else triggerCount[row.id].stoploss=0;

    if(!isNaN(sb)&&price>=sb){
      triggerCount[row.id].stopbuy++;
      speakAlert(`${ticker} triggered buy at $${price.toFixed(2)}`);
      if(triggerCount[row.id].stopbuy>=3){row.querySelector('.stopbuy-input').value=''; triggerCount[row.id].stopbuy=0;}
    } else triggerCount[row.id].stopbuy=0;

    // Warning prices
    const wpList=row.querySelector('.warning-input').value.split(',').map(x=>parseFloat(x)).filter(x=>!isNaN(x));
    wpList.forEach(wp=>{
      if(Math.abs(price-wp)<=Math.max(price*0.005,0.01)){
        speakAlert(`${ticker} near warning ${wp.toFixed(2)}`);
      }
    });

    // Day % alert
    const daypct=parseFloat(row.querySelector('.daypct-input').value);
    if(!isNaN(daypct)&&pct!==null){
      if((daypct<0&&pct<=daypct)||(daypct>0&&pct>=daypct)){
        triggerCount[row.id].daypct++;
        speakAlert(`${ticker} daily change ${pct.toFixed(2)}%`);
        if(triggerCount[row.id].daypct>=3){
          row.querySelector('.daypct-input').value='';
          triggerCount[row.id].daypct=0;
        }
      } else triggerCount[row.id].daypct=0;
    }

  }catch(err){console.error('fetch failed',err);}
}

function fetchAllTickers(){
  document.querySelectorAll('.ticker-row').forEach(row=>fetchTicker(row));
  $('status').textContent='Updated • '+(new Date()).toLocaleTimeString();
}

function startRefresh(){
  if(refreshTimer) clearInterval(refreshTimer);
  const ms=parseInt($('refresh').value);
  if(ms>0) refreshTimer=setInterval(fetchAllTickers,ms);
}

$('refresh').addEventListener('change',startRefresh);
$('addTicker').addEventListener('click',()=>addTickerRow());
$('clearAll').addEventListener('click',()=>clearAllCookies());

window.addEventListener('DOMContentLoaded',()=>{
  const cookies=document.cookie.split(';').map(c=>c.trim());
  cookies.forEach(c=>{
    const [name,value]=c.split('=');
    if(name.startsWith('row')&&value){
      try{
        const d=JSON.parse(decodeURIComponent(value));
        addTickerRow(d.ticker,d.url,d.stoploss,d.stopbuy,d.warning,d.daypct,d.ttsActive);
      }catch(e){deleteCookie(name);}
    }
  });
  if(document.querySelectorAll('.ticker-row').length===0) addTickerRow();
  startRefresh();
});
</script>
</body>
</html>
