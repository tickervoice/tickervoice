<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Investing.com Price TTS Demo</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:24px;background:#f7fafc;color:#0f172a}
.card{background:white;padding:18px;border-radius:12px;box-shadow:0 6px 18px rgba(15,23,42,0.08);max-width:950px}
input, button, select {padding:8px 10px;font-size:15px;border-radius:8px;border:1px solid #e6eef6;color:#000;}
button{background:#2563eb;color:white;border:0;font-weight:600;cursor:pointer;}
.row{display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
.grid{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
.kv{background:#f1f5f9;padding:12px;border-radius:8px;min-width:120px;text-align:center}
.muted{color:#64748b;font-size:14px}
.ticker-row input{width:120px;}
.ticker-row button{width:30px;}
</style>
</head>
<body>
<div class="card">
<h2>Investing.com Price Tracker Demo</h2>

<div class="row">
  <label>Refresh:
    <select id="refresh">
      <option value="5000" selected>5s</option>
      <option value="10000">10s</option>
      <option value="15000">15s</option>
      <option value="20000">20s</option>
      <option value="30000">30s</option>
      <option value="60000">60s</option>
    </select>
  </label>
  <button id="addTicker">+ Add Ticker</button>
  <button id="clearAll">Clear All</button>
</div>

<div id="status" class="muted">Ready.</div>
<div id="tickerContainer"></div>
</div>

<script>
const $ = id => document.getElementById(id);
let refreshTimer = null;
let triggerCount = {};  // consecutive stoploss/stopbuy triggers
let lastPrice = {};     // last price for TTS

// Cookie helpers
function setCookie(name,value,days=365){
  const d=new Date(); d.setTime(d.getTime()+days*24*60*60*1000);
  document.cookie=`${name}=${encodeURIComponent(value)};expires=${d.toUTCString()};path=/`;
}

function deleteCookie(name){
  document.cookie = name + '=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/';
}

function clearAllCookies(){
  document.cookie.split(';').forEach(c=>{
    const name = c.split('=')[0].trim();
    if(name.startsWith('row')) deleteCookie(name);
  });
  triggerCount = {};
  lastPrice = {};
  $('tickerContainer').innerHTML='';
}

// Format number safely
function safeNumber(x){return (x==null||Number.isNaN(x))?'0':Number(x).toLocaleString(undefined,{maximumFractionDigits:2});}

// TTS with reduced speed for mobile
function speak(text){
  if(window.speechSynthesis){
    const u=new SpeechSynthesisUtterance(text);
    u.lang='en-US';
    u.rate=1.3;  // slower than default
    window.speechSynthesis.speak(u);
  }
}

// Add ticker row
let tickerIndex=0;
function addTickerRow(ticker='', url='', stoploss='', stopbuy=''){
  tickerIndex++;
  const rowId = 'row'+tickerIndex;
  const container = $('tickerContainer');
  const row = document.createElement('div');
  row.className='row ticker-row';
  row.id=rowId;
  row.innerHTML=`
    <input class="ticker-input" placeholder="Ticker" value="${ticker}">
    <input class="url-input" type="hidden" value="${url}">
    <input class="stoploss-input" placeholder="StopLoss" value="${stoploss}">
    <input class="stopbuy-input" placeholder="StopBuy" value="${stopbuy}">
    <button class="remove-btn">-</button>
    <div class="grid card-${rowId}"><div class="kv"><strong>Price</strong><div>0</div></div></div>
  `;
  container.appendChild(row);

  const tickerInput=row.querySelector('.ticker-input');
  const urlInput=row.querySelector('.url-input');
  const stoplossInput=row.querySelector('.stoploss-input');
  const stopbuyInput=row.querySelector('.stopbuy-input');

  [stoplossInput, stopbuyInput].forEach(inp=>{
    inp.addEventListener('input', ()=>{
      let val = inp.value.replace(/[^\d.]/g,'');
      const parts = val.split('.');
      if(parts.length>2) val = parts[0]+'.'+parts.slice(1).join('');
      inp.value = val;
      saveRowCookie(row);
    });
  });

  // When ticker changes, remove old cookie & resolve new URL
  tickerInput.addEventListener('focusout', ()=>{
    deleteOldCookie(row);
    resolveInvestingUrl(tickerInput,urlInput);
  });

  [tickerInput, urlInput, stoplossInput, stopbuyInput].forEach(inp=>{
    inp.addEventListener('focusout', ()=>saveRowCookie(row));
    inp.addEventListener('input', ()=>saveRowCookie(row));
  });

  row.querySelector('.remove-btn').addEventListener('click', ()=>{
    deleteCookie(row.id);
    delete triggerCount[row.id];
    delete lastPrice[row.id];
    row.remove();
  });
}

// Delete old cookie if ticker changed
function deleteOldCookie(row){
  const oldCookie = row.id;
  deleteCookie(oldCookie);
}

// Save row cookie
function saveRowCookie(row){
  const ticker=row.querySelector('.ticker-input').value.trim();
  const url=row.querySelector('.url-input').value.trim();
  const stoploss=row.querySelector('.stoploss-input').value.trim();
  const stopbuy=row.querySelector('.stopbuy-input').value.trim();
  if(ticker) setCookie(row.id, JSON.stringify({ticker,url,stoploss,stopbuy}));
}

// Resolve Investing.com URL via search (requires proxy)
async function resolveInvestingUrl(tickerInput, urlInput){
  const query = tickerInput.value.trim();
  if(!query) return;
  try{
    const baseUrl='https://www.investing.com';
    const searchUrl = `${baseUrl}/search/?q=${encodeURIComponent(query)}`;
    const proxy = 'https://corsproxy.io/?'+encodeURIComponent(searchUrl);
    const resp = await fetch(proxy);
    const html = await resp.text();
    const m = html.match(/<a[^>]+js-inner-all-results-quote-item[^>]+href="([^"]+)"/);
    if(!m) return;
    const relativeLink = m[1];
    urlInput.value = baseUrl + relativeLink;
    saveRowCookie(tickerInput.closest('.ticker-row'));
  }catch(err){console.error('Failed to resolve Investing.com URL', err);}
}

// Fetch price from URL
async function fetchTicker(row){
  const url=row.querySelector('.url-input').value.trim();
  if(!url) return;
  try{
    const proxy='https://corsproxy.io/?'+encodeURIComponent(url);
    const resp = await fetch(proxy);
    const html = await resp.text();
    const match = html.match(/data-test="instrument-price-last">([\d.,]+)/);
    const price = match ? parseFloat(match[1].replace(/,/g,'')) : 0;

    const priceDiv=row.querySelector('.card-'+row.id+' div div');
    if(priceDiv) priceDiv.textContent = price.toFixed(2);

    // TTS only if price changed
    if(lastPrice[row.id] !== price){
      speak(`${row.querySelector('.ticker-input').value} price ${price.toFixed(2)}`);
      lastPrice[row.id] = price;
    }

    // Stop-loss / stop-buy triggers
    if(!triggerCount[row.id]) triggerCount[row.id]={stoploss:0, stopbuy:0};
    const sl=parseFloat(row.querySelector('.stoploss-input').value);
    const sb=parseFloat(row.querySelector('.stopbuy-input').value);

    if(!isNaN(sl)){
      if(price <= sl){
        triggerCount[row.id].stoploss++;
        speak(`${row.querySelector('.ticker-input').value} stopped out at $${price.toFixed(2)}`);
        if(triggerCount[row.id].stoploss >= 3){
          row.querySelector('.stoploss-input').value='';
          triggerCount[row.id].stoploss=0;
          saveRowCookie(row);
        }
      }else triggerCount[row.id].stoploss=0;
    }

    if(!isNaN(sb)){
      if(price >= sb){
        triggerCount[row.id].stopbuy++;
        speak(`${row.querySelector('.ticker-input').value} triggered buy at $${price.toFixed(2)}`);
        if(triggerCount[row.id].stopbuy >= 3){
          row.querySelector('.stopbuy-input').value='';
          triggerCount[row.id].stopbuy=0;
          saveRowCookie(row);
        }
      }else triggerCount[row.id].stopbuy=0;
    }

  }catch(err){console.error('Error fetching', url, err);}
}

// Fetch all tickers
function fetchAllTickers(){
  document.querySelectorAll('.ticker-row').forEach(row=>fetchTicker(row));
  $('status').textContent='Updated â€¢ '+(new Date()).toLocaleTimeString();
}

// Auto-refresh
function startRefresh(){
  if(refreshTimer) clearInterval(refreshTimer);
  const ms=parseInt($('refresh').value);
  if(ms>0) refreshTimer=setInterval(fetchAllTickers, ms);
}

// Events
$('refresh').addEventListener('change', startRefresh);
$('addTicker').addEventListener('click', ()=>addTickerRow());
$('clearAll').addEventListener('click', ()=>clearAllCookies());

// Load cookies
window.addEventListener('DOMContentLoaded', ()=>{
  const cookies=document.cookie.split(';').map(c=>c.trim());
  cookies.forEach(c=>{
    const [name,value]=c.split('=');
    if(name.startsWith('row') && value){
      try{
        const data=JSON.parse(decodeURIComponent(value));
        addTickerRow(data.ticker,data.url,data.stoploss,data.stopbuy);
      }catch(e){
        deleteCookie(name); // remove invalid cookie
      }
    }
  });
  if(document.querySelectorAll('.ticker-row').length===0) addTickerRow();
  startRefresh();
});
</script>
</body>
</html>
