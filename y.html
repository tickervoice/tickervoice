<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Yahoo/YFinance TTS Demo</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:24px;background:#f7fafc;color:#0f172a}
.card{background:white;padding:18px;border-radius:12px;box-shadow:0 6px 18px rgba(15,23,42,0.08);max-width:950px}
input, button, select {padding:8px 10px;font-size:15px;border-radius:8px;border:1px solid #e6eef6;color:#000;}
button{background:#2563eb;color:white;border:0;font-weight:600;cursor:pointer;}
.row{display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
.ticker-row{flex-direction:column;align-items:flex-start;border:1px solid #e5e7eb;padding:8px;border-radius:10px;margin-bottom:10px;background:#fafafa;width:100%;}
.ticker-line1{display:flex;align-items:center;gap:6px;width:100%}
.ticker-line2{display:flex;align-items:center;gap:6px;width:100%;margin-top:4px}
.ticker-row input{flex:1}
.remove-btn{flex:0 0 30px}
.price-box{margin-left:auto;min-width:110px;text-align:right;}
.warning-input{flex:2}
.daypct-input{flex:1;max-width:100px}
.muted{color:#64748b;font-size:14px}
</style>
</head>
<body>
<div class="card">
<h2>Yahoo/YFinance — TTS Demo</h2>

<div class="row">
  <select id="interval">
    <option value="1m">1m</option>
    <option value="5m" selected>5m</option>
    <option value="10m">10m</option>
    <option value="15m">15m</option>
    <option value="20m">20m</option>
    <option value="30m">30m</option>
    <option value="1h">1h</option>
  </select>
  <button id="go">Get</button>
  <select id="refresh">
    <option value="0">Auto-refresh: Off</option>
    <option value="15000" selected>Every 15s</option>
    <option value="30000">Every 30s</option>
    <option value="60000">Every 1m</option>
  </select>
  <button id="addTicker">+ Add Ticker</button>
  <button id="clearAll">Clear All</button>
</div>

<div id="status" class="muted">Ready.</div>
<div id="tickerContainer"></div>
</div>

<script>
const $ = id=>document.getElementById(id);
let refreshTimer=null, lastClose={}, triggerCount={};

// --- TTS voices ---
let maleVoice=null, femaleVoice=null;
function loadVoices(){
  const voices=speechSynthesis.getVoices();
  maleVoice=voices.find(v=>/male|David|Google UK English Male/i.test(v.name))||voices[0];
  femaleVoice=voices.find(v=>/female|Zira|Google US English/i.test(v.name))||voices[1]||voices[0];
}
if(speechSynthesis.onvoiceschanged!==undefined) speechSynthesis.onvoiceschanged=loadVoices;
loadVoices();

function speakNormal(text){
  const u=new SpeechSynthesisUtterance(text);
  u.lang='en-US'; u.rate=1.6; u.pitch=1.0; if(maleVoice) u.voice=maleVoice;
  window.speechSynthesis.speak(u);
}
function speakAlert(text){
  const u=new SpeechSynthesisUtterance(text);
  u.lang='en-US'; u.rate=1.4; u.pitch=1.2; if(femaleVoice) u.voice=femaleVoice;
  window.speechSynthesis.speak(u);
}

// --- Cookies ---
function setCookie(name,value,days=365){
  const d=new Date(); d.setTime(d.getTime()+days*24*60*60*1000);
  document.cookie=`${name}=${encodeURIComponent(value)};expires=${d.toUTCString()};path=/`;
}
function deleteCookie(name){ document.cookie=name+'=; expires=Thu,01 Jan 1970 00:00:00 GMT; path=/'; }
function clearAllCookies(){ 
  document.cookie.split(';').forEach(c=>{ const name=c.split('=')[0].trim(); if(name.startsWith('row-')) deleteCookie(name); }); 
  lastClose={}; triggerCount={}; $('tickerContainer').innerHTML='';
}

// --- Helpers ---
function safeNumber(x){return (x==null||Number.isNaN(x))?'—':Number(x).toLocaleString(undefined,{maximumFractionDigits:2});}
function genKey(){ return 'row-'+Math.random().toString(36).substr(2,9); }

// --- Add ticker row ---
function addTickerRow(ticker='',stoploss='',stopbuy='',warning='',daypct='',ttsActive=false,key=null){
  const rowKey=key||genKey();
  const row=document.createElement('div'); row.className='ticker-row'; row.dataset.key=rowKey;
  row.innerHTML=`
    <div class="ticker-line1">
      <input class="ticker-input" placeholder="Ticker" value="${ticker}">
      <input class="stoploss-input" placeholder="StopLoss" value="${stoploss}" ${stoploss?'':'disabled'}>
      <input class="stopbuy-input" placeholder="StopBuy" value="${stopbuy}" ${stopbuy?'':'disabled'}>
      <button class="remove-btn">-</button>
      <div class="price-box">
        <span class="price">0</span> 
        <span class="pct">0%</span> 
        <span class="prev-close muted">(Prev: 0)</span>
      </div>
    </div>
    <div class="ticker-line2">
      <input class="warning-input" placeholder="Warning Prices" value="${warning}">
      <input class="daypct-input" placeholder="Day %" value="${daypct}">%
      <label><input type="checkbox" class="tts-checkbox" ${ttsActive?'checked':''}> Regular TTS</label>
    </div>
  `;
  $('tickerContainer').appendChild(row);

  const tickerInput=row.querySelector('.ticker-input');
  const stoplossInput=row.querySelector('.stoploss-input');
  const stopbuyInput=row.querySelector('.stopbuy-input');
  const warningInput=row.querySelector('.warning-input');
  const daypctInput=row.querySelector('.daypct-input');
  const ttsBox=row.querySelector('.tts-checkbox');
  const priceSpan=row.querySelector('.price');
  const pctSpan=row.querySelector('.pct');
  const prevSpan=row.querySelector('.prev-close');

  row.querySelector('.remove-btn').addEventListener('click',()=>{ deleteRowCookie(rowKey); row.remove(); });

  [stoplossInput,stopbuyInput].forEach(inp=>{
    inp.addEventListener('input',()=>{
      let val=inp.value.replace(/[^\d.]/g,'');
      const parts=val.split('.'); if(parts.length>2) val=parts[0]+'.'+parts.slice(1).join('');
      inp.value=val; saveRowCookie(row);
    });
  });

  warningInput.addEventListener('input', () => {
	  let val = warningInput.value.replace(/[^0-9.,]/g, '');
	  const parts = val.split(',');
	  const cleanedParts = parts.map(p => {
	    const dotParts = p.split('.');
	    return dotParts.length > 2 ? dotParts[0] + '.' + dotParts.slice(1).join('') : p;
	  });
	  warningInput.value = cleanedParts.join(',');
	});

  daypctInput.addEventListener('input', () => {
	  let val = daypctInput.value.replace(/[^0-9.\-]/g, '');
	  const num = parseFloat(val);
	  if (!isNaN(num) && (num < -99.99 || num > 99.99)) val = '';
	  daypctInput.value = val;
	});

  function saveRowCookie(){
    const obj={ticker:tickerInput.value.trim(),
               stoploss:stoplossInput.value.trim(),
               stopbuy:stopbuyInput.value.trim(),
               warning:warningInput.value.trim(),
               daypct:daypctInput.value.trim(),
               ttsActive:ttsBox.checked};
    if(obj.ticker) setCookie(rowKey,JSON.stringify(obj));
  }
  [tickerInput,stoplossInput,stopbuyInput,warningInput,daypctInput,ttsBox].forEach(inp=>{inp.addEventListener('input',saveRowCookie); inp.addEventListener('change',saveRowCookie); });
}

// --- Delete cookie ---
function deleteRowCookie(key){ if(key) deleteCookie(key); delete lastClose[key]; delete triggerCount[key]; }

// --- Last close minute mapping ---
function getLastMinuteOfInterval(interval) {
  switch(interval) {
    case '1m': return 15*60 + 59;
    case '5m': return 15*60 + 55;
    case '10m': return 15*60 + 50;
    case '15m': return 15*60 + 45;
    case '20m': return 15*60 + 40;
    case '30m': return 15*60 + 30;
    case '1h': return 15*60 + 30;
    default: return 15*60 + 55;
  }
}

// --- Fetch ticker ---
async function fetchTicker(row){
  const sym=row.querySelector('.ticker-input').value.trim();
  if(!sym) return;
  const interval=$('interval').value;
  const url=`https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(sym)}?range=5d&interval=${interval}`;

  try{
    const data=await fetchWithProxy(url);
    const res=data.chart.result[0];
    const q=res.indicators.quote[0];
    const ts=res.timestamp;
    let idx=ts.length-1; while(idx>=0 && q.close[idx]==null) idx--;
    if(idx<0) return;

    const c=q.close[idx];
    const priceSpan=row.querySelector('.price');
    const pctSpan=row.querySelector('.pct');
    const prevSpan=row.querySelector('.prev-close');
    priceSpan.textContent=c!=null?c.toFixed(2):'—';

    function tsToEDT(ts) {
      const d=new Date(ts*1000);
      const edtStr=d.toLocaleString('en-US',{timeZone:'America/New_York'});
      return new Date(edtStr);
    }

    const today=tsToEDT(ts[idx]).getDate();
    const lastMinute=getLastMinuteOfInterval(interval);
    let prevClose=null;

    for(let i=idx-1;i>=0;i--){
      const dt=tsToEDT(ts[i]);
      const h=dt.getHours(), m=dt.getMinutes();
      if(dt.getDate()!==today && (h*60 + m) >= lastMinute){
        prevClose=q.close[i];
        break;
      }
    }
    if(prevClose==null) prevClose=c;
    prevSpan.textContent=`(Prev: ${prevClose!=null?prevClose.toFixed(2):'—'})`;

    const pctChange=(prevClose>0 && c!=null)?((c-prevClose)/prevClose*100):0;
    pctSpan.textContent=pctChange.toFixed(2)+'%';

    const stoplossInput=row.querySelector('.stoploss-input');
    const stopbuyInput=row.querySelector('.stopbuy-input');
    if(c!=null){ stoplossInput.disabled=false; stopbuyInput.disabled=false; } 
    else { stoplossInput.disabled=true; stopbuyInput.disabled=true; }

    const key=row.dataset.key;
    const ttsActive=row.querySelector('.tts-checkbox').checked;
    if(lastClose[key]!==c && c!=null){ if(ttsActive) speakNormal(`${sym} $${c.toFixed(2)}`); lastClose[key]=c; }
    if(!triggerCount[key]) triggerCount[key]={stoploss:0, stopbuy:0};

    const sl=parseFloat(stoplossInput.value);
    const sb=parseFloat(stopbuyInput.value);
    if(!isNaN(sl)&&c<=sl){ triggerCount[key].stoploss++; speakAlert(`${sym} stopped out at $${c.toFixed(2)}`); if(triggerCount[key].stoploss>=3){stoplossInput.value=''; triggerCount[key].stoploss=0; saveRowCookie(row);} } else triggerCount[key].stoploss=0;
    if(!isNaN(sb)&&c>=sb){ triggerCount[key].stopbuy++; speakAlert(`${sym} triggered buy at $${c.toFixed(2)}`); if(triggerCount[key].stopbuy>=3){stopbuyInput.value=''; triggerCount[key].stopbuy=0; saveRowCookie(row);} } else triggerCount[key].stopbuy=0;

    const wpList=row.querySelector('.warning-input').value.split(',').map(x=>parseFloat(x)).filter(x=>!isNaN(x));
    function formatWP(wp){ return Number.isInteger(wp)?wp.toString():wp.toFixed(2); }
    wpList.forEach(wp=>{ if(Math.abs(c-wp)<=Math.max(c*0.005,0.01)) speakAlert(`${sym} near warning ${formatWP(wp)}`); });

    const daypct=parseFloat(row.querySelector('.daypct-input').value);
    if(!isNaN(daypct)){
      if((daypct<0 && pctChange<=daypct)||(daypct>0 && pctChange>=daypct)) speakAlert(`${sym} daily change ${pctChange.toFixed(2)}%`);
    }

  }catch(err){ console.error('fetch failed',sym,err); }
}

// --- Fetch all ---
async function fetchAllTickers(){ 
  document.querySelectorAll('.ticker-row').forEach(row=>fetchTicker(row)); 
  $('status').textContent='Updated • '+(new Date()).toLocaleTimeString(); 
}

// --- Fetch with proxy ---
async function fetchWithProxy(url){ 
  try{ const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error(r.status); return await r.json(); }
  catch(e){ const proxy='https://corsproxy.io/?'+encodeURIComponent(url); const r2=await fetch(proxy,{cache:'no-store'}); if(!r2.ok) throw new Error('Proxy '+r2.status); return await r2.json(); }
}

// --- Auto-refresh ---
function startRefresh(){ if(refreshTimer) clearInterval(refreshTimer); const ms=parseInt($('refresh').value); if(ms>0) refreshTimer=setInterval(fetchAllTickers,ms); }

// --- Events ---
$('go').addEventListener('click',fetchAllTickers);
$('interval').addEventListener('change',fetchAllTickers);
$('refresh').addEventListener('change',startRefresh);
$('addTicker').addEventListener('click',()=>addTickerRow());
$('clearAll').addEventListener('click',()=>clearAllCookies());

// --- Load cookies ---
window.addEventListener('DOMContentLoaded',()=>{
  const cookies=document.cookie.split(';').map(c=>c.trim()); let restored=0;
  cookies.forEach(c=>{
    const eq=c.indexOf('='); if(eq<0) return;
    const name=c.substring(0,eq).trim();
    const value=c.substring(eq+1).trim();
    if(name.startsWith('row-')&&value){
      try{ const d=JSON.parse(decodeURIComponent(value)); addTickerRow(d.ticker,d.stoploss,d.stopbuy,d.warning,d.daypct,d.ttsActive,name); restored++; }catch(e){}
    }
  });
  if(restored===0) addTickerRow();
  fetchAllTickers(); startRefresh();
});
</script>
</body>
</html>
